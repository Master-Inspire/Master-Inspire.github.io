<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" content="text/html">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"/>

    <!--COMMENTED OUT!-->
    <!--<script src="bower_components/jquery/dist/jquery.js"></script>-->
    <!--<script src="bower_components/underscore/underscore.js"></script>-->
    <!--<script src="bower_components/backbone/backbone.js"></script>-->
    <!--<script src="bower_components/foundation-sites/dist/foundation.js"></script>-->
    <!--<script src="bower_components/marked/lib/marked.js"></script>-->
    <!--<link href="bower_components/foundation-sites/dist/foundation-flex.css" rel="stylesheet">-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.3/backbone-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.0/foundation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.0/foundation-flex.min.css" rel="stylesheet">

    <title>Animus Blog</title>

    <script>
        'use strict';
        $(document).ready(function() {
            $(this).foundation();

            (function(_, Backbone, $, marked) {
                var Router = Backbone.Router.extend({
                    switchView: function(view) {
                        var model = this.articleList.findWhere(view);
                        new ContentView({ model: model });
                    },

                    articleByPath: function(action) {
                        this.switchView({ title: action });
                    },

                    articleByIndex: function(index) {
                        var id             = parseInt(index);
                        this._currentIndex = id;
                        this.switchView({ id: id });
                    },

                    catchAll: function(action) {
                        console.log('catchAll');
                        if (action == null) {
                            this.toRandom();
                        } else {
                            new ContentView();
                        }
                    },

                    _currentIndex: 0,
                    currentModel : null,

                    toRandom: _.debounce(function() {
                        this._currentIndex = _.random(0, this.articleList.length - 1);
                        this.navigate("!/" + this._currentIndex, { trigger: true });
                    }, 500, { trailing: false }),

                    toNext: _.debounce(function() {
                        this._currentIndex = this._currentIndex + 1;
                        if (this._currentIndex >= this.articleList.length) {
                            this._currentIndex = 0;
                        }
                        this.navigate("!/" + this._currentIndex, { trigger: true });
                    }, 500, { trailing: false }),

                    toPrevious: _.debounce(function() {
                        this._currentIndex = this._currentIndex - 1;
                        if (this._currentIndex < 0) {
                            this._currentIndex = this.articleList.length - 1;
                        }
                        this.navigate("!/" + this._currentIndex, { trigger: true });
                    }, 500, { trailing: false }),

                    initialize: function() {
                        // catchAll first;
                        var regexpRoutes = [
                            [/^(.*)$/, 'catchAll', this.catchAll],
                            [/^!(\/.*\.md)$/, 'articleByPath', this.articleByPath],
                            [/^!\/(\d+)$/, 'articleByIndex', this.articleByIndex]
                        ];
                        var that         = this;
                        _.each(regexpRoutes, function(r) {
                            that.route.apply(that, r);
                        });

                        this.articleList = new ArticleList();
                        this.articleList.fetchList({
                            success: function() {
                                Backbone.history.start({ pushState: false, hashChange: true });
                            },
                            error  : function(error) {
                                new ContentView();
                                console.log(error);
                            }
                        });
                    },
                    routes    : {}
                });

                var AppView = Backbone.View.extend({
                    initialize: function() {
                        var that = this;
                        that.randomBackground();
                        setInterval(function() {
                            that.randomBackground();
                        }, 2000);
                        this.router = new Router();
                    },

                    el: document.getElementsByTagName('body')[0],

                    events: {
                        'keydown'        : 'keyAction',
                        'click #previous': 'clickPrevious',
                        'click #next'    : 'clickNext',
                        'click #random'  : 'clickRandom'
                    },

                    keyAction    : function(e) {
                        // 13: Enter, random; 37: Left, previous; 39: Right, next.
                        var keys = [13, 37, 39];
                        var i    = keys.indexOf(e.which);
                        if (i !== -1) {
                            var action = [this.clickRandom, this.clickPrevious, this.clickNext];
                            action[i].call(this, e);
                        }
                    },
                    clickRandom  : function() {
                        console.log('random');
                        this.router.toRandom();
                    },
                    clickPrevious: function() {
                        console.log('previous');
                        this.router.toPrevious();
                    },
                    clickNext    : function() {
                        console.log('next');
                        this.router.toNext();
                    },

                    randomBackground: function() {
                        var r = _.random(0, 254),
                            g = _.random(0, 254),
                            b = _.random(0, 254),
                            a = Math.random();
                        this.$el.add('footer').css('background-color',
                                'rgba(' + r + ',' + g + ',' + b + ',' + a + ')');
                    }
                });

                var ArticleModel = Backbone.Model.extend({

                    defaults: function() {
                        return {
                            id     : 0,
                            title  : null,
                            content: null
                        };
                    },

                    loadContent: function(options) {
                        options   = options || {};
                        var title = this.get('title');
                        var that  = this;
                        $.get(title).done(function(data) {
                            that.set({ content: data });
                            _.isFunction(options.success) && options.success();
                        }).fail(function() {
                            _.isFunction(options.error) && options.error();
                        });
                    }
                });

                var ArticleList = Backbone.Collection.extend({

                    model: ArticleModel,
                    url  : 'list.txt',

                    fetchList: function(options) {
                        options  = options || {};
                        var that = this;
                        $.get(this.url).done(function(data) {
                            var array  = data.toString()
                                    .split('\n')
                                    .filter(function(value) {
                                        return value.trim() !== '';
                                    });
                            var result = _.map(array, function(value, index) {
                                return { id: index, title: value, content: null };
                            });
                            that.set(result);
                            console.log(that);
                            _.isFunction(options.success) && options.success(result);
                        }).fail(function() {
                            _.isFunction(options.error) && options.error();
                        });
                    }
                });

                var ContentView = Backbone.View.extend({

                    el        : document.getElementById('contentView'),
                    errorEl   : $('#errorView'),
                    initialize: function() {
                        var that = this;
                        try {
                            this.model.loadContent({
                                success: function() {
                                    that.render();
                                },
                                error  : function() {
                                    that.renderError();
                                }
                            });
                        } catch (e) {
                            that.renderError();
                        }
                    },

                    render: function() {
                        try {
                            this.$el.empty();
                            var raw = this.model.get('content');
                            this.$el.html(marked(raw));
                        } catch (e) {
                            this.$el.html(this.errorEl.html());
                            console.log(e);
                        }
                    },

                    renderError: function() {
                        this.$el.empty();
                        this.$el.html(this.errorEl.html());
                    }
                });

                new AppView();
            })(window._, window.Backbone, $, marked);
        });
    </script>
    <style>
        body {
            width: 95vw;
            overflow-x: hidden;
        }

        #contentView {
            margin-top: 5vh;
            min-height: 82vh;
        }

        .error {
            position: absolute;
            left: 10px;
            right: 10px;
            bottom: 10px;
            top: 10px;
            color: red;
        }

        footer {
            margin: 0 !important;
            padding-bottom: 0.5rem !important;
            padding-top: 0.5rem !important;
        }
    </style>
</head>
<body class="row expanded">

    <div class="column hide-for-small-only medium-2 large-2 hide-for-print"></div>
    <div class="column small-12 medium-8 large-8">
        <div id="contentView" class="callout secondary">
        </div>
        <footer class=" show-for-small-only row callout expanded">
            <a class="float-left" id="previous">Previous</a>
            <a class="float-center" id="random">Random</a>
            <a class="float-right" id="next">Next</a>
        </footer>
    </div>
    <div class="column hide-for-small-only medium-2  large-2 hide-for-print"></div>
    <template id="errorView">
        <div class="error callout alert">
            <h1>Opps...!</h1>

            <h3>Something went wrong!</h3>
        </div>
    </template>
</body>
</html>
